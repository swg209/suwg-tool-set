<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>在线便签贴/白板 - AI工具集</title>
    <meta name="description" content="在线便签贴/白板">
    
    <!-- 样式文件 -->
    <link rel="stylesheet" href="../../shared/css/common.css">
    
    <!-- 工具特定样式 -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.5em;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toolbar {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .tool-group {
            display: flex;
            gap: 5px;
            padding: 5px;
            background: rgba(255,255,255,0.8);
            border-radius: 8px;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .tool-btn {
            padding: 8px 12px;
            background: none;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            color: #555;
        }

        .tool-btn:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .tool-btn.active {
            background: #667eea;
            color: white;
        }

        .color-picker {
            width: 40px;
            height: 32px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid rgba(0,0,0,0.1);
        }

        .size-slider {
            width: 80px;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            cursor: pointer;
        }

        .workspace {
            position: fixed;
            top: 80px;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            background: 
                radial-gradient(circle at 25px 25px, #ddd 2px, transparent 2px),
                radial-gradient(circle at 75px 75px, #ddd 2px, transparent 2px);
            background-size: 100px 100px;
            background-position: 0 0, 50px 50px;
        }

        .whiteboard {
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair;
        }

        .sticky-note {
            position: absolute;
            min-width: 200px;
            min-height: 150px;
            background: #ffeb3b;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            cursor: move;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid rgba(0,0,0,0.1);
            resize: both;
            overflow: hidden;
        }

        .sticky-note:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        .sticky-note.dragging {
            transform: rotate(5deg) scale(1.05);
            z-index: 1000;
        }

        .sticky-header {
            background: rgba(0,0,0,0.1);
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
        }

        .sticky-title {
            font-size: 12px;
            font-weight: bold;
            color: rgba(0,0,0,0.7);
        }

        .sticky-controls {
            display: flex;
            gap: 5px;
        }

        .sticky-btn {
            width: 20px;
            height: 20px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.8);
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .sticky-btn:hover {
            background: rgba(255,255,255,1);
            transform: scale(1.1);
        }

        .sticky-content {
            padding: 12px;
            height: calc(100% - 36px);
        }

        .sticky-textarea {
            width: 100%;
            height: 100%;
            border: none;
            background: transparent;
            resize: none;
            outline: none;
            font-family: 'Comic Neue', cursive, sans-serif;
            font-size: 14px;
            line-height: 1.4;
            color: var(--text-primary);
        }

        .sticky-textarea::placeholder {
            color: rgba(0,0,0,0.4);
        }

        .floating-menu {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }

        .fab {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .fab.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .fab.secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .color-palette {
            position: fixed;
            top: 100px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            display: none;
            flex-direction: column;
            gap: 10px;
            z-index: 1001;
        }

        .palette-title {
            font-weight: bold;
            color: var(--text-primary);
            text-align: center;
            margin-bottom: 5px;
        }

        .palette-colors {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .palette-color {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .palette-color:hover {
            transform: scale(1.1);
            border-color: #667eea;
        }

        .brush-settings {
            position: fixed;
            top: 100px;
            left: 20px;
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            display: none;
            flex-direction: column;
            gap: 15px;
            z-index: 1001;
            min-width: 200px;
        }

        .setting-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .setting-label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }

        .setting-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .brush-preview {
            width: 100%;
            height: 50px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
        }

        .save-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 25px;
            font-weight: 600;
            z-index: 2000;
            display: none;
        }

        .shortcuts-help {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: var(--radius-md);
            border: 1px solid rgba(0,0,0,0.1);
            font-size: 12px;
            color: var(--text-secondary);
            max-width: 300px;
            display: none;
        }

        .shortcuts-help h4 {
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            margin: 4px 0;
        }

        .shortcut-key {
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .header {
                padding: var(--spacing-md) 15px;
                flex-direction: column;
                gap: 10px;
            }
            
            .header h1 {
                font-size: 1.2em;
            }
            
            .toolbar {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .workspace {
                top: 120px;
            }
            
            .sticky-note {
                min-width: 150px;
                min-height: 120px;
            }
            
            .floating-menu {
                bottom: 20px;
                right: 20px;
            }
            
            .fab {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="tool-container">
        <!-- 工具头部 -->
        <header class="tool-header">
            <div class="tool-header-content">
                <a href="../../index.html" class="back-btn">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M10 4l-4 4 4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    返回工具集
                </a>
                
                <div class="tool-title">
                    <h1>在线便签贴/白板</h1>
                    <p class="tool-subtitle">在线便签贴/白板</p>
                </div>
                
                <button class="theme-toggle" id="themeToggle" aria-label="切换主题">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                        <circle cx="10" cy="10" r="4" stroke="currentColor" stroke-width="2"/>
                        <path d="M10 2v2M10 16v2M18 10h-2M4 10H2M15.66 4.34l-1.41 1.41M5.75 14.25l-1.41 1.41M15.66 15.66l-1.41-1.41M5.75 5.75L4.34 4.34" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
        </header>

        <!-- 工具主内容 -->
        <main class="tool-main">
            <div class="tool-card">
                <div class="tool-section">
                    <h2>
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                            <rect x="3" y="3" width="14" height="14" rx="2" stroke="currentColor" stroke-width="2"/>
                        </svg>
                        工具功能
                    </h2>
                    
                    
            <div class="tool-card">
                <div class="tool-section">
                    <h2>
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                            <rect x="3" y="3" width="14" height="14" rx="2" stroke="currentColor" stroke-width="2"/>
                        </svg>
                        在线便签贴/白板
                    </h2>
                    <div class="container">
                        <div class="header">
        <h1>📝 在线便签贴/白板</h1>
        <div class="toolbar">
            <div class="tool-group">
                <button class="tool-btn active" id="moveMode" onclick="setMode('move')" title="移动模式">👆</button>
                <button class="tool-btn" id="drawMode" onclick="setMode('draw')" title="绘画模式">✏️</button>
                <button class="tool-btn" id="eraseMode" onclick="setMode('erase')" title="橡皮擦">🧽</button>
            </div>
            
            <div class="tool-group">
                <input type="color" class="color-picker" id="colorPicker" value="#667eea" title="选择颜色">
                <input type="range" class="size-slider" id="brushSize" min="1" max="20" value="3" title="画笔大小">
            </div>
            
            <div class="tool-group">
                <button class="tool-btn" onclick="toggleColorPalette()" title="颜色板">🎨</button>
                <button class="tool-btn" onclick="toggleBrushSettings()" title="画笔设置">🖌️</button>
                <button class="tool-btn" onclick="clearCanvas()" title="清空画布">🗑️</button>
            </div>
            
            <div class="tool-group">
                <button class="tool-btn" onclick="saveWorkspace()" title="保存">💾</button>
                <button class="tool-btn" onclick="loadWorkspace()" title="加载">📁</button>
                <button class="tool-btn" onclick="exportWorkspace()" title="导出图片">📷</button>
            </div>
            
            <div class="tool-group">
                <button class="tool-btn" onclick="toggleHelp()" title="快捷键">❓</button>
                <button class="tool-btn" onclick="toggleFullscreen()" title="全屏">⛶</button>
            </div>
        </div>
    </div>

    <div class="workspace" id="workspace">
        <canvas class="whiteboard" id="whiteboard"></canvas>
    </div>

    <div class="floating-menu">
        <button class="fab primary" onclick="addStickyNote()" title="添加便签">📝</button>
        <button class="fab secondary" onclick="toggleColorPalette()" title="颜色板">🎨</button>
    </div>

    <div class="color-palette" id="colorPalette">
        <div class="palette-title">便签颜色</div>
        <div class="palette-colors">
            <div class="palette-color" style="background: #ffeb3b" onclick="setStickyColor('#ffeb3b')"></div>
            <div class="palette-color" style="background: #ff9800" onclick="setStickyColor('#ff9800')"></div>
            <div class="palette-color" style="background: #f44336" onclick="setStickyColor('#f44336')"></div>
            <div class="palette-color" style="background: #e91e63" onclick="setStickyColor('#e91e63')"></div>
            <div class="palette-color" style="background: #9c27b0" onclick="setStickyColor('#9c27b0')"></div>
            <div class="palette-color" style="background: #673ab7" onclick="setStickyColor('#673ab7')"></div>
            <div class="palette-color" style="background: #3f51b5" onclick="setStickyColor('#3f51b5')"></div>
            <div class="palette-color" style="background: #2196f3" onclick="setStickyColor('#2196f3')"></div>
            <div class="palette-color" style="background: #03a9f4" onclick="setStickyColor('#03a9f4')"></div>
            <div class="palette-color" style="background: #00bcd4" onclick="setStickyColor('#00bcd4')"></div>
            <div class="palette-color" style="background: #009688" onclick="setStickyColor('#009688')"></div>
            <div class="palette-color" style="background: #4caf50" onclick="setStickyColor('#4caf50')"></div>
            <div class="palette-color" style="background: #8bc34a" onclick="setStickyColor('#8bc34a')"></div>
            <div class="palette-color" style="background: #cddc39" onclick="setStickyColor('#cddc39')"></div>
            <div class="palette-color" style="background: #795548" onclick="setStickyColor('#795548')"></div>
            <div class="palette-color" style="background: #607d8b" onclick="setStickyColor('#607d8b')"></div>
        </div>
    </div>

    <div class="brush-settings" id="brushSettings">
        <div class="setting-group">
            <div class="setting-label">画笔类型</div>
            <div class="setting-row">
                <select id="brushType" onchange="updateBrushSettings()">
                    <option value="round">圆形</option>
                    <option value="square">方形</option>
                    <option value="marker">马克笔</option>
                </select>
            </div>
        </div>
        
        <div class="setting-group">
            <div class="setting-label">透明度</div>
            <div class="setting-row">
                <input type="range" id="brushOpacity" min="0.1" max="1" step="0.1" value="1" onchange="updateBrushSettings()">
                <span id="opacityValue">100%</span>
            </div>
        </div>
        
        <div class="setting-group">
            <div class="setting-label">画笔预览</div>
            <canvas class="brush-preview" id="brushPreview" width="200" height="50"></canvas>
        </div>
    </div>

    <div class="save-indicator" id="saveIndicator">
        ✅ 已自动保存
    </div>

    <div class="shortcuts-help" id="shortcutsHelp">
        <h4>快捷键</h4>
        <div class="shortcut-item">
            <span>移动模式</span>
            <span class="shortcut-key">M</span>
        </div>
        <div class="shortcut-item">
            <span>绘画模式</span>
            <span class="shortcut-key">D</span>
        </div>
        <div class="shortcut-item">
            <span>橡皮擦</span>
            <span class="shortcut-key">E</span>
        </div>
        <div class="shortcut-item">
            <span>添加便签</span>
            <span class="shortcut-key">N</span>
        </div>
        <div class="shortcut-item">
            <span>保存</span>
            <span class="shortcut-key">Ctrl+S</span>
        </div>
        <div class="shortcut-item">
            <span>清空画布</span>
            <span class="shortcut-key">Ctrl+K</span>
        </div>
    </div>

    
                    </div>
                </div>
            </div>
                    <!-- 结果显示区域 -->
                    <div class="result-display" id="result">
                        <pre id="resultContent">处理结果将在这里显示...</pre>
                    </div>
                </div>
            </div>
        </main>

        <!-- 工具页脚 -->
        <footer class="tool-footer">
            <p>由 <a href="../../index.html">AI工具集</a> 提供 | 原创工具</p>
        </footer>
    </div>

    <!-- JavaScript -->
    <script src="../../shared/js/utils.js"></script>
    <script>
        // 工具特定的JavaScript代码
        class ToolApp {
            constructor() {
                this.init();
            }

            init() {
                this.setupEventListeners();
            }

            setupEventListeners() {
                document.getElementById('processBtn').addEventListener('click', () => this.process());
                document.getElementById('clearBtn').addEventListener('click', () => this.clear());
                document.getElementById('copyBtn').addEventListener('click', () => this.copyResult());
                
                // 实时处理（可选）
                document.getElementById('input').addEventListener('input', 
                    ToolUtils.debounce(() => this.process(), 300)
                );
            }

            process() {
                const input = document.getElementById('input').value;
                const result = this.processInput(input);
                this.displayResult(result);
            }

            processInput(input) {
                
        // 全局变量
        let currentMode = 'move';
        let isDrawing = false;
        let isErasing = false;
        let canvas, ctx;
        let stickyNotes = [];
        let currentStickyColor = '#ffeb3b';
        let brushSize = 3;
        let brushColor = '#667eea';
        let brushOpacity = 1.0;
        let brushType = 'round';
        let lastX = 0;
        let lastY = 0;
        let draggedNote = null;
        let dragOffset = { x: 0, y: 0 };

        // 初始化
        function init() {
            setupCanvas();
            setupEventListeners();
            loadWorkspace();
            updateBrushPreview();
            
            // 定期自动保存
            setInterval(autoSave, 30000); // 每30秒自动保存
        }

        function setupCanvas() {
            canvas = document.getElementById('whiteboard');
            ctx = canvas.getContext('2d');
            
            // 设置画布大小
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // 设置画布样式
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
        }

        function resizeCanvas() {
            const workspace = document.getElementById('workspace');
            canvas.width = workspace.clientWidth * 2; // 高DPI支持
            canvas.height = workspace.clientHeight * 2;
            canvas.style.width = workspace.clientWidth + 'px';
            canvas.style.height = workspace.clientHeight + 'px';
            ctx.scale(2, 2);
        }

        function setupEventListeners() {
            // 画布事件
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // 触摸事件支持
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', handleTouch);
            
            // 工具栏事件
            document.getElementById('colorPicker').addEventListener('change', (e) => {
                brushColor = e.target.value;
                updateBrushPreview();
            });
            
            document.getElementById('brushSize').addEventListener('input', (e) => {
                brushSize = e.target.value;
                updateBrushPreview();
            });
            
            // 键盘快捷键
            document.addEventListener('keydown', handleKeyboard);
            
            // 便签拖拽
            document.addEventListener('mousedown', startDragSticky);
            document.addEventListener('mousemove', dragSticky);
            document.addEventListener('mouseup', stopDragSticky);
            
            // 防止右键菜单
            document.addEventListener('contextmenu', e => e.preventDefault());
        }

        function setMode(mode) {
            currentMode = mode;
            
            // 更新按钮状态
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(mode + 'Mode').classList.add('active');
            
            // 更新鼠标样式
            switch(mode) {
                case 'move':
                    canvas.style.cursor = 'default';
                    break;
                case 'draw':
                    canvas.style.cursor = 'crosshair';
                    break;
                case 'erase':
                    canvas.style.cursor = 'grab';
                    break;
            }
        }

        function startDrawing(e) {
            if (currentMode !== 'draw' && currentMode !== 'erase') return;
            
            isDrawing = true;
            isErasing = currentMode === 'erase';
            
            const rect = canvas.getBoundingClientRect();
            lastX = e.clientX - rect.left;
            lastY = e.clientY - rect.top;
            
            // 开始新的路径
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
        }

        function draw(e) {
            if (!isDrawing) return;
            
            const rect = canvas.getBoundingClientRect();
            const currentX = e.clientX - rect.left;
            const currentY = e.clientY - rect.top;
            
            ctx.lineWidth = brushSize;
            
            if (isErasing) {
                ctx.globalCompositeOperation = 'destination-out';
                ctx.globalAlpha = 1;
            } else {
                ctx.globalCompositeOperation = 'source-over';
                ctx.globalAlpha = brushOpacity;
                ctx.strokeStyle = brushColor;
            }
            
            // 绘制线条
            ctx.lineTo(currentX, currentY);
            ctx.stroke();
            
            // 更新最后位置
            lastX = currentX;
            lastY = currentY;
        }

        function stopDrawing() {
            if (!isDrawing) return;
            
            isDrawing = false;
            isErasing = false;
            ctx.globalAlpha = 1;
            ctx.globalCompositeOperation = 'source-over';
            
            // 自动保存
            autoSave();
        }

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0] || e.changedTouches[0];
            const mouseEvent = new MouseEvent(e.type.replace('touch', 'mouse'), {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }

        function addStickyNote() {
            const workspace = document.getElementById('workspace');
            
            const note = document.createElement('div');
            note.className = 'sticky-note';
            note.style.backgroundColor = currentStickyColor;
            note.style.left = Math.random() * (workspace.clientWidth - 200) + 'px';
            note.style.top = Math.random() * (workspace.clientHeight - 150) + 'px';
            
            const noteId = 'note_' + Date.now();
            note.id = noteId;
            
            note.innerHTML = `
                <div class="sticky-header">
                    <div class="sticky-title">便签 #${stickyNotes.length + 1}</div>
                    <div class="sticky-controls">
                        <button class="sticky-btn" onclick="changeStickyColor('${noteId}')" title="更换颜色">🎨</button>
                        <button class="sticky-btn" onclick="duplicateSticky('${noteId}')" title="复制">📋</button>
                        <button class="sticky-btn" onclick="deleteSticky('${noteId}')" title="删除">❌</button>
                    </div>
                </div>
                <div class="sticky-content">
                    <textarea class="sticky-textarea" placeholder="在这里输入内容..." onblur="autoSave()"></textarea>
                </div>
            `;
            
            workspace.appendChild(note);
            stickyNotes.push({
                id: noteId,
                element: note,
                x: parseInt(note.style.left),
                y: parseInt(note.style.top),
                color: currentStickyColor,
                content: ''
            });
            
            // 聚焦到文本框
            const textarea = note.querySelector('.sticky-textarea');
            setTimeout(() => textarea.focus(), 100);
            
            autoSave();
        }

        function deleteSticky(noteId) {
            const note = document.getElementById(noteId);
            if (note && confirm('确定要删除这个便签吗？')) {
                note.remove();
                stickyNotes = stickyNotes.filter(n => n.id !== noteId);
                autoSave();
            }
        }

        function duplicateSticky(noteId) {
            const originalNote = stickyNotes.find(n => n.id === noteId);
            if (!originalNote) return;
            
            const workspace = document.getElementById('workspace');
            const note = document.createElement('div');
            note.className = 'sticky-note';
            note.style.backgroundColor = originalNote.color;
            note.style.left = (originalNote.x + 20) + 'px';
            note.style.top = (originalNote.y + 20) + 'px';
            
            const newNoteId = 'note_' + Date.now();
            note.id = newNoteId;
            
            note.innerHTML = `
                <div class="sticky-header">
                    <div class="sticky-title">便签 #${stickyNotes.length + 1}</div>
                    <div class="sticky-controls">
                        <button class="sticky-btn" onclick="changeStickyColor('${newNoteId}')" title="更换颜色">🎨</button>
                        <button class="sticky-btn" onclick="duplicateSticky('${newNoteId}')" title="复制">📋</button>
                        <button class="sticky-btn" onclick="deleteSticky('${newNoteId}')" title="删除">❌</button>
                    </div>
                </div>
                <div class="sticky-content">
                    <textarea class="sticky-textarea" placeholder="在这里输入内容..." onblur="autoSave()">${originalNote.content}</textarea>
                </div>
            `;
            
            workspace.appendChild(note);
            stickyNotes.push({
                id: newNoteId,
                element: note,
                x: originalNote.x + 20,
                y: originalNote.y + 20,
                color: originalNote.color,
                content: originalNote.content
            });
            
            autoSave();
        }

        function changeStickyColor(noteId) {
            toggleColorPalette();
            window.currentChangingNote = noteId;
        }

        function setStickyColor(color) {
            if (window.currentChangingNote) {
                const note = document.getElementById(window.currentChangingNote);
                if (note) {
                    note.style.backgroundColor = color;
                    const stickyData = stickyNotes.find(n => n.id === window.currentChangingNote);
                    if (stickyData) {
                        stickyData.color = color;
                    }
                    autoSave();
                }
                window.currentChangingNote = null;
            } else {
                currentStickyColor = color;
            }
            
            document.getElementById('colorPalette').style.display = 'none';
        }

        function startDragSticky(e) {
            if (currentMode !== 'move') return;
            
            const target = e.target.closest('.sticky-note');
            if (!target) return;
            
            // 如果点击的是文本框，不启动拖拽
            if (e.target.classList.contains('sticky-textarea')) return;
            
            draggedNote = target;
            const rect = target.getBoundingClientRect();
            dragOffset.x = e.clientX - rect.left;
            dragOffset.y = e.clientY - rect.top;
            
            target.classList.add('dragging');
            target.style.zIndex = '1000';
        }

        function dragSticky(e) {
            if (!draggedNote) return;
            
            e.preventDefault();
            const workspace = document.getElementById('workspace');
            const workspaceRect = workspace.getBoundingClientRect();
            
            let newX = e.clientX - workspaceRect.left - dragOffset.x;
            let newY = e.clientY - workspaceRect.top - dragOffset.y;
            
            // 边界检查
            newX = Math.max(0, Math.min(newX, workspace.clientWidth - draggedNote.offsetWidth));
            newY = Math.max(0, Math.min(newY, workspace.clientHeight - draggedNote.offsetHeight));
            
            draggedNote.style.left = newX + 'px';
            draggedNote.style.top = newY + 'px';
        }

        function stopDragSticky() {
            if (!draggedNote) return;
            
            draggedNote.classList.remove('dragging');
            draggedNote.style.zIndex = '';
            
            // 更新便签数据
            const stickyData = stickyNotes.find(n => n.id === draggedNote.id);
            if (stickyData) {
                stickyData.x = parseInt(draggedNote.style.left);
                stickyData.y = parseInt(draggedNote.style.top);
            }
            
            draggedNote = null;
            autoSave();
        }

        function toggleColorPalette() {
            const palette = document.getElementById('colorPalette');
            palette.style.display = palette.style.display === 'flex' ? 'none' : 'flex';
            
            // 隐藏其他面板
            document.getElementById('brushSettings').style.display = 'none';
        }

        function toggleBrushSettings() {
            const settings = document.getElementById('brushSettings');
            settings.style.display = settings.style.display === 'flex' ? 'none' : 'flex';
            
            // 隐藏其他面板
            document.getElementById('colorPalette').style.display = 'none';
        }

        function updateBrushSettings() {
            const opacitySlider = document.getElementById('brushOpacity');
            const opacityValue = document.getElementById('opacityValue');
            brushType = document.getElementById('brushType').value;
            brushOpacity = parseFloat(opacitySlider.value);
            
            opacityValue.textContent = Math.round(brushOpacity * 100) + '%';
            updateBrushPreview();
        }

        function updateBrushPreview() {
            const previewCanvas = document.getElementById('brushPreview');
            if (!previewCanvas) return;
            
            const previewCtx = previewCanvas.getContext('2d');
            previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
            
            previewCtx.globalAlpha = brushOpacity;
            previewCtx.strokeStyle = brushColor;
            previewCtx.lineWidth = brushSize;
            previewCtx.lineCap = brushType === 'square' ? 'square' : 'round';
            
            previewCtx.beginPath();
            previewCtx.moveTo(20, 25);
            previewCtx.lineTo(180, 25);
            previewCtx.stroke();
        }

        function clearCanvas() {
            if (confirm('确定要清空画布吗？这将删除所有绘画内容。')) {
                ctx.clearRect(0, 0, canvas.width / 2, canvas.height / 2);
                autoSave();
            }
        }

        function saveWorkspace() {
            try {
                const workspaceData = {
                    stickyNotes: stickyNotes.map(note => ({
                        id: note.id,
                        x: note.x,
                        y: note.y,
                        color: note.color,
                        content: note.element.querySelector('.sticky-textarea').value
                    })),
                    canvas: canvas.toDataURL(),
                    timestamp: new Date().toISOString()
                };
                
                localStorage.setItem('whiteboard_data', JSON.stringify(workspaceData));
                showSaveIndicator();
            } catch (error) {
                console.error('保存失败:', error);
                alert('保存失败，请检查浏览器存储设置');
            }
        }

        function loadWorkspace() {
            try {
                const savedData = localStorage.getItem('whiteboard_data');
                if (!savedData) return;
                
                const workspaceData = JSON.parse(savedData);
                
                // 清空现有内容
                stickyNotes.forEach(note => note.element.remove());
                stickyNotes = [];
                
                // 加载便签
                if (workspaceData.stickyNotes) {
                    workspaceData.stickyNotes.forEach(noteData => {
                        const workspace = document.getElementById('workspace');
                        const note = document.createElement('div');
                        note.className = 'sticky-note';
                        note.id = noteData.id;
                        note.style.backgroundColor = noteData.color;
                        note.style.left = noteData.x + 'px';
                        note.style.top = noteData.y + 'px';
                        
                        note.innerHTML = `
                            <div class="sticky-header">
                                <div class="sticky-title">便签</div>
                                <div class="sticky-controls">
                                    <button class="sticky-btn" onclick="changeStickyColor('${noteData.id}')" title="更换颜色">🎨</button>
                                    <button class="sticky-btn" onclick="duplicateSticky('${noteData.id}')" title="复制">📋</button>
                                    <button class="sticky-btn" onclick="deleteSticky('${noteData.id}')" title="删除">❌</button>
                                </div>
                            </div>
                            <div class="sticky-content">
                                <textarea class="sticky-textarea" placeholder="在这里输入内容..." onblur="autoSave()">${noteData.content}</textarea>
                            </div>
                        `;
                        
                        workspace.appendChild(note);
                        stickyNotes.push({
                            id: noteData.id,
                            element: note,
                            x: noteData.x,
                            y: noteData.y,
                            color: noteData.color,
                            content: noteData.content
                        });
                    });
                }
                
                // 加载画布
                if (workspaceData.canvas) {
                    const img = new Image();
                    img.onload = function() {
                        ctx.clearRect(0, 0, canvas.width / 2, canvas.height / 2);
                        ctx.drawImage(img, 0, 0);
                    };
                    img.src = workspaceData.canvas;
                }
                
            } catch (error) {
                console.error('加载失败:', error);
            }
        }

        function autoSave() {
            // 更新便签内容
            stickyNotes.forEach(note => {
                const textarea = note.element.querySelector('.sticky-textarea');
                if (textarea) {
                    note.content = textarea.value;
                }
            });
            
            saveWorkspace();
        }

        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.style.display = 'block';
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 2000);
        }

        function exportWorkspace() {
            const workspace = document.getElementById('workspace');
            const exportCanvas = document.createElement('canvas');
            const exportCtx = exportCanvas.getContext('2d');
            
            exportCanvas.width = workspace.clientWidth;
            exportCanvas.height = workspace.clientHeight;
            
            // 绘制背景
            exportCtx.fillStyle = '#f5f7fa';
            exportCtx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);
            
            // 绘制画布内容
            exportCtx.drawImage(canvas, 0, 0, exportCanvas.width, exportCanvas.height);
            
            // 下载图片
            const link = document.createElement('a');
            link.download = `whiteboard_${new Date().toISOString().slice(0, 10)}.png`;
            link.href = exportCanvas.toDataURL();
            link.click();
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        function toggleHelp() {
            const help = document.getElementById('shortcutsHelp');
            help.style.display = help.style.display === 'block' ? 'none' : 'block';
        }

        function handleKeyboard(e) {
            // 如果焦点在文本框中，忽略快捷键
            if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') return;
            
            switch(e.key.toLowerCase()) {
                case 'm':
                    setMode('move');
                    break;
                case 'd':
                    setMode('draw');
                    break;
                case 'e':
                    setMode('erase');
                    break;
                case 'n':
                    addStickyNote();
                    break;
                case 's':
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        saveWorkspace();
                    }
                    break;
                case 'k':
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        clearCanvas();
                    }
                    break;
                case 'f11':
                    e.preventDefault();
                    toggleFullscreen();
                    break;
            }
        }

        // 页面加载完成后初始化
        window.addEventListener('load', init);
        
        // 页面卸载前保存
        window.addEventListener('beforeunload', autoSave);
    
                return input;
            }

            displayResult(result) {
                document.getElementById('resultContent').textContent = result;
            }

            clear() {
                document.getElementById('input').value = '';
                document.getElementById('resultContent').textContent = '处理结果将在这里显示...';
            }

            copyResult() {
                const result = document.getElementById('resultContent').textContent;
                if (result && result !== '处理结果将在这里显示...') {
                    ToolUtils.copyToClipboard(result);
                } else {
                    ToolUtils.showToast('没有可复制的内容', 'warning');
                }
            }
        }

        // 初始化应用
        document.addEventListener('DOMContentLoaded', () => {
            new ToolApp();
        });
    </script>
</body>
</html>
